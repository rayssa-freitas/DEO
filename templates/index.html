<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Movimentação de Pessoas - Horários de Pico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f9fafd; }
    .card { border-radius: 1rem; margin-top: 2rem; }
    #grafico { background: white; padding: 1rem; border-radius: 1rem;}
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h2 class="mb-3">Horários de Pico por Tipologia</h2>
      <form id="form-busca" class="row g-3">
        <div class="col-md-4">
          <label for="tipologia" class="form-label">Tipologia</label>
          <select class="form-select" id="tipologia" required>
            <option value="">Selecione...</option>
            <option value="shopping">Shopping</option>
            <option value="restaurante">Restaurante</option>
            <option value="hotel">Hotel</option>
            <option value="supermercado">Supermercado</option>
            <option value="farmacia">Farmácia</option>
            <!-- Adapte para o que tem no seu CSV! -->
          </select>
        </div>
        <div class="col-md-4">
          <label for="city_state" class="form-label">Cidade/Estado</label>
          <select class="form-select" id="city_state" required>
            <option value="">Selecione...</option>
          </select>        
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Pesquisar</button>
        </div>
      </form>
    </div>

    <div class="card p-4 mt-4" id="resultado-section" style="display:none;">
      <h4 class="mb-3">Fluxo de Movimentação (0–1)</h4>
      <canvas id="grafico" height="80"></canvas>
      <a id="btnDownload" class="btn btn-success mt-3" style="display:none;">Baixar TXT</a>
    </div>
  </div>

<script>

let chartRef = null;

window.onload = async function carregarOptions() {
  const resp = await fetch('/options');
  const data = await resp.json();

  const tipologiaSelect = document.getElementById('tipologia');
  const cidadeSelect = document.getElementById('city_state');

  data.tipologias.forEach(t => {
    const option = document.createElement('option');
    option.value = t.value;
    option.text = t.label;
    tipologiaSelect.appendChild(option);
  });

  data.cidades.forEach(c => {
    const option = document.createElement('option');
    option.value = c;
    option.text = c;
    cidadeSelect.appendChild(option);
  });
};

document.getElementById('form-busca').onsubmit = async function(e) {
  e.preventDefault();
  const tipologia = document.getElementById('tipologia').value;
  const city_state = document.getElementById('city_state').value;

  const resp = await fetch(`/search?tipologia=${encodeURIComponent(tipologia)}&city_state=${encodeURIComponent(city_state)}`);
  if (!resp.ok) {
    alert('Erro ao buscar dados');
    return;
  }
  const data = await resp.json();

  // Processa os dados do backend
  const horas = Array.from({length: 24}, (_, i) => i);

  function arrToSeries(arr) {
    let vals = Array(24).fill(null);
    (arr || []).forEach(e => { vals[e.hora] = e.valor; });
    return vals;
  }

  const datasets = [
    {
      label: "Dia Típico (Seg–Sex)",
      data: arrToSeries(data.dia_tipico),
      borderColor: "#0a6fd8",
      fill: false
    },
    {
      label: "Sábado",
      data: arrToSeries(data.sabado),
      borderColor: "#21c96b",
      fill: false
    },
    {
      label: "Domingo",
      data: arrToSeries(data.domingo),
      borderColor: "#e23c4e",
      fill: false
    }
  ];

  // Gera o gráfico (Chart.js)
  const ctx = document.getElementById('grafico').getContext('2d');
  if (chartRef) { chartRef.destroy(); }
  chartRef = new Chart(ctx, {
    type: 'line',
    data: {
      labels: horas.map(h => h.toString().padStart(2,'0') + ":00"),
      datasets: datasets
    },
    options: {
      responsive: true,
      interaction: {mode: 'index', intersect: false},
      plugins: {
        title: {display: false},
        tooltip: {enabled: true},
        legend: {position: 'top'}
      },
      scales: {
        y: {min: 0, max: 1, title: {display:true, text: "Fluxo (0–1)"}},
        x: {title: {display:true, text: "Hora do Dia"}}
      }
    }
  });
  
  fetch('/options')
  .then(res => res.json())
  .then(data => {
    const tipologiaSelect = document.getElementById('tipologia');
    const cidadeSelect = document.getElementById('cidade');

    data.tipologias.forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = t;
      tipologiaSelect.appendChild(option);
    });

    data.cidades.forEach(c => {
      const option = document.createElement('option');
      option.value = c;
      option.textContent = c;
      cidadeSelect.appendChild(option);
    });
  });

  async function carregarOptions() {
    const resp = await fetch('/options');
    const data = await resp.json();
    // Preencher o select de tipologia e cidade/estado
    const tipologiaSelect = document.getElementById('tipologia');
    data.tipologias.forEach(t => {
      tipologia.innerHTML += `<option value="${t}">${t}</option>`;
    });
    const cidadeSelect = document.getElementById('cidadeSelect');
    data.cidades.forEach(c => {
      cidadeSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
  }
  window.onload = carregarOptions;

  document.getElementById('resultado-section').style.display = '';
  // Baixar TXT
  let txt = '';
  for (const [key, arr] of Object.entries(data)) {
    txt += `=== ${key.toUpperCase()} ===\n`;
    (arr || []).forEach(e => {
      txt += `${e.hora.toString().padStart(2,'0')}:00\t${e.valor}\n`;
    });
    txt += '\n';
  }
  const blob = new Blob([txt], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  const btn = document.getElementById('btnDownload');
  btn.href = url;
  btn.download = `fluxo_${tipologia}_${city_state.replace('/','-')}.txt`;
  btn.style.display = 'inline-block';
};
</script>
</body>
</html>